#!/usr/bin/make -f

require-program = $(or $(shell which $1),$(error ./configure requires the '$1' program in order to run))

tools/bazel   := $(call require-program,bazel)
tools/jq      := $(call require-program,jq)
tools/go      := $(call require-program,go)
tools/python3 := $(call require-program,python3)
tools/gazelle := $(tools/bazel) run //:gazelle --

.DELETE_ON_ERROR:
.SECONDARY:

build: $(CURDIR)/.generate-BUILDs
clean: $(CURDIR)/.clean
.PHONY: build clean

%/.clean:
	rm -rf $(@D)/vendor
	find $(@D) -mindepth 2 \( -name BUILD -o -name BUILD.bazel \) -type f -delete
.PHONY: %/.clean

%/WORKSPACE: %/WORKSPACE.in %/python/WORKSPACE
	set -e; { \
	  cat $*/WORKSPACE.in; \
	  grep -v '^workspace(' $*/python/WORKSPACE; \
	} > $@

%/.generate-BUILDs: %/WORKSPACE %/BUILD %/vendor %/.mangle-BUILD %/python/configure
	find $(@D) -mindepth 2 \( -name BUILD -o -name BUILD.bazel \) -type f -delete
	cd $(@D) && $(tools/gazelle) -external vendored
	find $(@D) -mindepth 2 -name BUILD -type f -exec $*/.mangle-BUILD {} +
	cd $(@D)/python && ./configure
.PHONY: %/.generate-BUILDS

%/vendor: %/go.mod
	rm -rf $@
	cd $(@D) && $(tools/go) mod vendor

#!/usr/bin/make -f

tools/bazel = $(shell which bazel)
tools/jq = $(shell which jq)
tools/go = $(shell which go)
tools/gazelle = $(tools/bazel) run //:gazelle --

.DELETE_ON_ERROR:
.SECONDARY:

build: $(CURDIR)/.generate-gazelle
clean: $(CURDIR)/.clean
.PHONY: build clean

%/.clean:
	rm -rf $(@D)/vendor
	find $(@D) \( -name BUILD -o -name BUILD.bazel \) -type f -delete
.PHONY: %/.clean

%/.generate-gazelle: %/WORKSPACE %/BUILD %/vendor
	find . -mindepth 2 \( -name BUILD -o -name BUILD.bazel \) -type f -delete
	cd $(@D) && $(tools/gazelle)
	find . -mindepth 2 -name BUILD -type f -exec sed -i.bak '1i# File generated by ./generate; DO NOT EDIT.\n' -- {} +
	find . -name BUILD.bak -type f -delete
.PHONY: %/.generate-gazelle

%/BUILD: %/go.mod %/BUILD.head $(firstword $(tools/go) $(tools/jq))
	rm -f $@
	{ \
	  echo '# File generated by ./generate; DO NOT EDIT.'; \
	  echo; \
	  cat $@.head; \
	  echo "# gazelle:prefix $$(GO111MODULE=on $(tools/go) mod edit -json | $(tools/jq) -r .Module.Path)"; \
	} > $@

%/vendor: %/go.mod
	rm -rf $@
	cd $(@D) && go mod vendor
